#!/bin/bash

# Set up virtualenv
setvirtualenvproject
add2virtualenv -d `pwd`
add2virtualenv `pwd`


# Specify your own requirements file, otherwise default to requirements/local.txt
if [ $# -ne 0 ]; then
    req=$1
else
    req='requirements/local.txt'
fi


# Pip install the requirements
pip install -r $req
fab target.local project.setup


# Set up our ruby environment
# TODO: Check for existence of rvm, if not, assume rbenv
rvm use `cat .ruby-version | tr -d "\n" && echo "@" | tr -d "\n" && cat .ruby-gemset`
bundle


# Install node.js dependencies
[ -d node_modules ] && rm -rf node_modules
npm install


# Run the postactivate hook
virtualenvwrapper_run_hook post_activate


# Create the database, this has to happen after the DJANGO_SETTINGS_MODULE has been set
fab target.local pg.create_db
django-admin.py syncdb --noinput
